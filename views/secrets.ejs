<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Secrets • WhisperLens</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .avatar {
      width: 36px; height: 36px; border-radius: 50%; display: inline-flex;
      align-items: center; justify-content: center; font-weight: 600; color: #fff;
    }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.08); }
    .ellipsis-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .cursor-pointer { cursor: pointer; }
  </style>
</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-md navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold" href="/">WhisperLens</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navc">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="navc" class="collapse navbar-collapse">
        <div class="ms-auto d-flex align-items-center gap-2">
          <% if (user) { %>
            <span class="navbar-text text-light small me-2">Hi, <%= user.username %></span>
            <a class="btn btn-outline-light btn-sm" href="/logout">Logout</a>
          <% } %>
        </div>
      </div>
    </div>
  </nav>

  <main class="container py-4">

    <!-- Flash -->
    <% if (typeof flash !== 'undefined' && flash) { %>
      <div class="alert alert-<%= flash.type %> alert-dismissible fade show" role="alert">
        <%= flash.message %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <!-- Header + tools -->
    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
      <h1 class="h4 mb-0">Latest Secrets</h1>
      <span class="badge text-bg-secondary"><%= (secrets && secrets.length) ? secrets.length : 0 %></span>

      <div class="ms-auto d-flex gap-2 align-items-center">
        <input id="searchBox" class="form-control form-control-sm" placeholder="Search text/summary…" style="min-width: 220px;">
        <select id="catFilter" class="form-select form-select-sm" style="width: 160px;">
          <option value="">All categories</option>
          <option>Work</option>
          <option>Family</option>
          <option>Finance</option>
          <option>Health</option>
          <option>School</option>
          <option>Advice</option>
          <option>Confession</option>
          <option>Other</option>
        </select>
        <select id="sortBy" class="form-select form-select-sm" style="width: 160px;">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="az">A–Z (summary/text)</option>
          <option value="za">Z–A (summary/text)</option>
        </select>
      </div>
    </div>

    <!-- Grid -->
    <div id="list" class="row g-3">
      <% if (secrets && secrets.length) { %>
        <% secrets.forEach(function(s) { %>
          <div class="col-12 col-md-6 col-lg-4 secret-card"
               data-cat="<%= s.aiCategory || 'Other' %>"
               data-text="<%= (s.aiSummary && s.aiSummary.trim().length ? s.aiSummary : s.text).replace(/"/g, '&quot;') %>"
               data-time="<%= new Date(s.createdAt).getTime() %>">

            <div class="card h-100 card-hover">
              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="d-flex align-items-center gap-2">
                    <% 
                      // Simple deterministic avatar background from pseudonym
                      const name = s.pseudonym || 'Anon';
                      let hash = 0; for (let i = 0; i < name.length; i++) hash = (hash*31 + name.charCodeAt(i)) >>> 0;
                      const palette = ["#E57373","#F06292","#BA68C8","#9575CD","#7986CB","#64B5F6","#4FC3F7","#4DD0E1","#4DB6AC","#81C784","#AED581","#DCE775","#FFF176","#FFD54F","#FFB74D","#A1887F","#90A4AE"];
                      const bg = palette[hash % palette.length];
                      const initials = name.slice(0,2).toUpperCase();
                    %>
                    <div class="avatar" style="background:<%= bg %>"><%= initials %></div>
                    <div>
                      <div class="fw-semibold"><%= name %></div>
                      <small class="text-muted"><%= new Date(s.createdAt).toLocaleString() %></small>
                    </div>
                  </div>
                  <span class="badge text-bg-secondary"><%= s.aiCategory || 'Other' %></span>
                </div>

                <p class="mt-3 mb-2 ellipsis-2">
                  <%= (s.aiSummary && s.aiSummary.trim().length ? s.aiSummary : s.text) %>
                </p>

                <div class="mt-auto d-flex justify-content-between align-items-center">
                  <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#viewModal-<%= s._id %>">
                    View
                  </button>

                  <% if (String(s.ownerId) === String(currentUserId)) { %>
                    <form method="POST" action="/delete" onsubmit="return confirm('Delete this secret?');">
                      <input type="hidden" name="secretId" value="<%= s._id %>">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                    </form>
                  <% } %>
                </div>
              </div>
            </div>

            <!-- Modal -->
            <div class="modal fade" id="viewModal-<%= s._id %>" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">
                      <%= s.pseudonym || 'Anonymous' %>
                      <span class="badge text-bg-secondary ms-2"><%= s.aiCategory || 'Other' %></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p class="mb-1"><strong>Posted:</strong> <%= new Date(s.createdAt).toLocaleString() %></p>
                    <% if (s.aiSummary) { %>
                      <p class="mb-2"><strong>Summary:</strong> <%= s.aiSummary %></p>
                    <% } %>
                    <p class="mb-0"><strong>Text:</strong><br><%= s.text %></p>
                  </div>
                  <div class="modal-footer">
                    <% if (String(s.ownerId) === String(currentUserId)) { %>
                      <form method="POST" action="/delete" onsubmit="return confirm('Delete this secret?');" class="me-auto">
                        <input type="hidden" name="secretId" value="<%= s._id %>">
                        <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
                      </form>
                    <% } %>
                    <button class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        <% }) %>
      <% } else { %>
        <div class="col-12">
          <div class="alert alert-info">No secrets yet. Be the first to share one below.</div>
        </div>
      <% } %>
    </div>

    <!-- Client-side pagination (works on the 50 items sent by server) -->
    <div id="pagi" class="d-flex justify-content-center gap-2 my-3"></div>

    <!-- Composer -->
    <section class="card p-3 shadow-sm mt-4">
      <h2 class="h5">Post a new secret</h2>
      <form method="POST" action="/submit">
        <div class="mb-2">
          <textarea class="form-control" name="secret" rows="3" placeholder="Type your secret…" required></textarea>
        </div>
        <button class="btn btn-primary" type="submit">Submit</button>
      </form>
    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const cards = Array.from(document.querySelectorAll('.secret-card'));
      const list = document.getElementById('list');
      const searchBox = document.getElementById('searchBox');
      const catFilter = document.getElementById('catFilter');
      const sortBy = document.getElementById('sortBy');
      const pagi = document.getElementById('pagi');

      // Local state
      let q = '', cat = '', sort = 'newest';
      const PAGE_SIZE = 9;
      let page = 1;

      function normalize(s){ return (s||'').toLowerCase(); }

      function apply() {
        // filter
        let items = cards.filter(c => {
          const txt = normalize(c.dataset.text);
          const hasQ = !q || txt.includes(q);
          const hasCat = !cat || (c.dataset.cat === cat);
          return hasQ && hasCat;
        });

        // sort
        items.sort((a,b) => {
          if (sort === 'newest') return (+b.dataset.time) - (+a.dataset.time);
          if (sort === 'oldest') return (+a.dataset.time) - (+b.dataset.time);
          const ta = a.dataset.text, tb = b.dataset.text;
          if (sort === 'az') return ta.localeCompare(tb);
          if (sort === 'za') return tb.localeCompare(ta);
          return 0;
        });

        // pagination
        const totalPages = Math.max(1, Math.ceil(items.length / PAGE_SIZE));
        if (page > totalPages) page = totalPages;

        // render: hide all then show page
        cards.forEach(c => c.style.display = 'none');
        items.slice((page-1)*PAGE_SIZE, page*PAGE_SIZE).forEach(c => c.style.display = '');

        // build pager
        pagi.innerHTML = '';
        if (totalPages > 1) {
          const mk = (label, p, active=false) => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm ' + (active ? 'btn-primary' : 'btn-outline-primary');
            btn.textContent = label;
            btn.onclick = (e) => { e.preventDefault(); page = p; apply(); };
            return btn;
          };
          if (page > 1) pagi.appendChild(mk('«', 1));
          if (page > 1) pagi.appendChild(mk('‹', page-1));
          for (let i=Math.max(1,page-2); i<=Math.min(totalPages,page+2); i++) {
            pagi.appendChild(mk(String(i), i, i===page));
          }
          if (page < totalPages) pagi.appendChild(mk('›', page+1));
          if (page < totalPages) pagi.appendChild(mk('»', totalPages));
        }
      }

      searchBox.addEventListener('input', e => { q = normalize(e.target.value); page = 1; apply(); });
      catFilter.addEventListener('change', e => { cat = e.target.value; page = 1; apply(); });
      sortBy.addEventListener('change', e => { sort = e.target.value; page = 1; apply(); });

      // initial render
      apply();
    })();
  </script>
</body>
</html>
